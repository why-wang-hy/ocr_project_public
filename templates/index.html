<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ–‡æ¡£è§£æé˜…è¯»å™¨ (Pro ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath@1.0.0/texmath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // é…ç½® PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* ==================== 2. å…¨å±€ä¸åŸºç¡€å¸ƒå±€ ==================== */
        body { 
            margin: 0; padding: 0; display: flex; height: 100vh; 
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, sans-serif; 
            background-color: #f6f8fa; overflow: hidden; position: relative; 
        }

        /* åŠ¨æ€èƒŒæ™¯å±‚ */
        #bgLayer {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("{{ url_for('static', filename='assets/bg.png') }}");
            background-size: cover; background-position: center; background-attachment: fixed;
            opacity: 1; z-index: -1; pointer-events: none;transition: background-image 0.8s ease-in-out; /* ğŸ‘ˆ æ·»åŠ å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        }

        /* æ‹–æ‹½ä¸Šä¼ è¦†ç›–å±‚æ ·å¼ */
        body.drag-over::before { 
            content: "ğŸ“„ é‡Šæ”¾æ–‡ä»¶ä»¥æé€Ÿä¸Šä¼ "; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(31,113,235,0.3); z-index: 10000; 
            display: flex; justify-content: center; align-items: center; 
            color: white; font-size: 30px; pointer-events: none; 
            backdrop-filter: blur(4px);
        }

        /* å·¦å³åˆ†æ å¸ƒå±€å®¹å™¨ */
        .editor-container { width: 40%; height: 100%; display: flex; flex-direction: column; min-width: 200px; z-index: 1; }
        .preview-container { 
            flex: 1; height: 100%; overflow-y: auto; 
            background-color: rgba(255,255,255,0.85); 
            padding: 40px; box-sizing: border-box; min-width: 300px; 
            position: relative; z-index: 1;
            font-size: 16px; transition: font-size 0.2s ease;
        }
        .resizer { width: 5px; height: 100%; background-color: #ddd; cursor: col-resize; z-index: 2; }

        /* ==================== 3. UI ç»„ä»¶æ ·å¼ (Header/Buttons) ==================== */
        .header { 
            padding: 0 20px; background: #b5b5bf; color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            height: 50px; flex-shrink: 0; 
        }
        .header-title { font-size: 21px; font-family: "STXingkai", "STKaiti", "æ¥·ä½“", "åæ–‡æ¥·ä½“", serif; }

        .btn-group { display: flex; gap: 10px; align-items: center; /* ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œï¼Œé˜²æ­¢æŒ‰é’®çºµå‘æ‹‰ä¼¸ */ }
        .btn { 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; 
            padding: 6px 12px; font-size: 13px; font-weight: bold; cursor: pointer; 
            color: white; background-color: rgba(255,255,255,0.1); text-decoration: none;
            transition: background 0.2s;
        }
        .btn:hover { background-color: rgba(255,255,255,0.2); }
        .btn-primary { background-color: #bbd3df; } .btn-primary:hover { background-color: #aec3cf; }
        .btn-accent { background-color: #b8c0ed; } .btn-accent:hover { background-color: #abb2dc; }
        .btn-picture { background-color: #ebb5c8; } .btn-picture:hover { background-color: #e09aa4; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #footerControl {
            padding: 10px 20px; background-color: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #ddd; display: flex; justify-content: flex-end; flex-shrink: 0;
        }
        .font-control { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #333; }
        
        textarea#source { 
            width: 100%; 
            flex-grow: 1; 
            border: none; 
            /* å…³é”®ä¿®å¤ 1ï¼šå¼ºåˆ¶å†…ç›’æ¨¡å‹ï¼Œé˜²æ­¢ padding æŠŠå®½åº¦æ’‘å¼€æˆ–ç¼©å° */
            box-sizing: border-box; 
            padding: 20px; 
            font-size: 14px; 
            font-family: 'Consolas', monospace; 
            resize: none; 
            outline: none; 
            /* æˆ–è€…ä½ å–œæ¬¢çš„åŠé€æ˜è‰²ï¼Œä½†å¿…é¡»ç¡®ä¿å®ƒè¦†ç›–æ•´ä¸ªåŒºåŸŸ */
            /* ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨åŠé€æ˜èƒŒæ™¯ */
            background-color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .setting-box {
            margin: 10px 0;
        }

        .toggle-container {
            cursor: pointer;
            display: block;
        }

        .toggle-container input {
            display: none; /* éšè—åŸå§‹å¤é€‰æ¡† */
        }

        .toggle-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.5); /*#f3d0a4*/
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            transition: all 0.3s ease;
            user-select: none;
        }
        .toggle-card span {
            font-size: 14px;       /* è°ƒæ•´å­—å·å¤§å° */
            font-weight: 600;     /* è°ƒæ•´ç²—ç»† (400ä¸ºæ­£å¸¸, 700ä¸ºç²—ä½“) */
            color: #ffffff;       /* è°ƒæ•´å­—ä½“é¢œè‰² */
            font-family: "Inter", "Microsoft YaHei", sans-serif; /* è°ƒæ•´å­—ä½“æ— */
            letter-spacing: 0.5px; /* è°ƒæ•´å­—é—´è·ï¼Œå¢åŠ å­¦æœ¯è´¨æ„Ÿ */
        }

        /* é€‰ä¸­åçš„æ ·å¼ */
        .toggle-container input:checked + .toggle-card {
            background: rgba(0, 0, 0, 0.7); /*#f3d0a4*/
            border: 1px solid rgba(255,255,255,0.2);
        }

        .toggle-container input:checked + .toggle-card #toggleStatus {
            color: #f3d0a4;
            font-weight: bold;
        }

        .toggle-card:hover {
            background: rgba(0, 0, 0, 0.7); /*#f3d0a4*/
            border: 1px solid rgba(255,255,255,0.2);
        }

        #toggleStatus {
            margin-left: 5px;
            font-size: 13px; font-weight: bold;
            color: #f3d0a4;
        }

        .delete-btn {
            background: none; border: none; cursor: pointer; padding: 5px 10px;
            border-radius: 4px; transition: background 0.2s; font-size: 16px;
        }
        .delete-btn:hover { background: rgba(255, 0, 0, 0.1); transform: scale(1.1); }

        /* ==================== 4. Markdown ä¸ Math å…¬å¼ä¸“é¡¹ä¼˜åŒ– ==================== */
        /* è¦†ç›– Markdown é»˜è®¤å­—ä½“ï¼Œæ›´åƒè®ºæ–‡ */
        .markdown-body { font-family: "Times New Roman", Times, serif; }

        /* KaTeX å…¬å¼å®¹å™¨ä¼˜åŒ–ï¼šé˜²æ­¢è¿‡é•¿å…¬å¼æº¢å‡º */
        .markdown-body .katex-display {
            display: block; margin: 1.4em 0 !important; padding: 15px 0;
            width: 100%; overflow-x: auto; text-align: center;
        }
        .markdown-body .katex { margin: 0 3px; font-size: 1.2em; } /* è¡Œå†…å…¬å¼å¾®è°ƒ */

        /* é’ˆå¯¹ cases ç¯å¢ƒï¼ˆæ–¹ç¨‹ç»„ï¼‰å†…éƒ¨çš„è¡Œé—´è·å¾®è°ƒ */
        .markdown-body .matrix-dot {
            margin-top: 5px;
        }

        /* å›¾ç‰‡ä¸è¡¨æ ¼å±…ä¸­ */
        .markdown-body img { display: block; margin: 0 auto; max-width: 80%; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .markdown-body table { margin: 0 auto; display: table; width: auto; min-width: 50%; }
        .markdown-body table + p, .markdown-body img + p { text-align: center; font-size: 0.9em; color: #666; margin-top: 10px; }

        /* ç¿»è¯‘å¯¹ç…§å—æ ·å¼ */
        .markdown-body blockquote {
            margin: 10px 0 25px 0; padding: 10px 20px;
            color: #555; background-color: #f9fdfc;
            border-left: 4px solid #5bbeb0; border-radius: 0 8px 8px 0;
            font-style: normal; line-height: 1.6;
        }
        /* åŸæ–‡æ®µè½æ ·å¼ */
        .markdown-body p:not(blockquote p) { font-weight: 500; color: #000; margin-bottom: 5px; }
        /* å¼•ç”¨å—å†…çš„å…¬å¼åŠ æ·±é¢œè‰² */
        .markdown-body blockquote .katex-display { color: #333; }

        /* è®© Markdown è¡¨æ ¼åœ¨é¢„è§ˆåŒºæ›´ç¾è§‚ï¼Œä¸”æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
        .markdown-body table { 
            margin: 15px auto; 
            display: block; /* å…³é”®ï¼šå…è®¸ overflow ç”Ÿæ•ˆ */
            width: max-content; 
            max-width: 100%; 
            overflow-x: auto; 
            border-collapse: collapse;
        }

        .markdown-body th, .markdown-body td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }

        .markdown-body tr:nth-child(2n) {
            background-color: #f6f8fa;
        }

        /* ==================== 5. PDF é˜…è¯»å™¨æ ¸å¿ƒæ ·å¼ ==================== */
        #pdfViewer {
            flex: 1; overflow-y: scroll; background-color: rgba(82, 86, 89, 0.75);
            display: none; padding: 10px; box-sizing: border-box;
            /* å…³é”®ä¿®å¤ï¼šé˜²æ­¢ Flex å¸ƒå±€å‹ç¼© */
            min-height: 1px; min-width: 1px;
        }
        #pdfViewer canvas {
            display: block; margin: 0 auto 15px auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            /* å…³é”®ä¿®å¤ï¼šä¿è¯ Canvas å“åº”å¼ä¸”ä¸å¤±çœŸ */
            max-width: 100%; height: auto !important; 
        }

        /* ==================== 6. æ¨¡æ€æ¡†ä¸é®ç½©å±‚ ==================== */
        /* èº«ä»½ç™»å½•å±‚ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #bfcfff 0%, #2cade0 100%);
            z-index: 99999; display: flex; justify-content: center; align-items: center; color: white;
            transition: opacity 0.5s ease;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px rgba(31,38,135,0.37);
            border: 1px solid rgba(255,255,255,0.18); text-align: center; max-width: 600px; width: 90%;
        }
        .user-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; margin-top: 30px; }
        .user-btn {
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px; padding: 15px; color: white; cursor: pointer; font-weight: bold;
            transition: transform 0.3s;
        }
        .user-btn:hover { background: white; color: #194a7a; transform: translateY(-5px); }
        .user-avatar { font-size: 30px; display: block; margin-bottom: 10px; }

        /* 1. è°ƒæ•´â€œé€‰æ‹©ä½ çš„èº«ä»½â€æ ‡é¢˜å­—ä½“ */
        .login-card h2 {
            font-size: 24px;            /* æ˜¾è‘—å¢å¤§æ ‡é¢˜ */
            font-weight: 800;
            margin-bottom: 30px;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2); /* å¢åŠ æŠ•å½±ï¼Œä½¿å…¶åœ¨æ¸å˜èƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
        }

        /* 2. ä¸“é—¨å¢å¤§ç™»å½•å±‚å†…çš„æŒ‰é’®å­—ä½“ï¼Œä½¿å…¶åŒºåˆ«äºé¡µé¢å†…çš„å°æŒ‰é’® */
        #loginOverlay .user-btn {
            font-size: 17px;            /* å°†ç”¨æˆ·åå­—ä½“è°ƒå¤§ï¼ˆä¹‹å‰é€šå¸¸æ˜¯ 13px æˆ– 14pxï¼‰ */
            padding: 20px 10px;         /* å¢åŠ å†…è¾¹è·ï¼Œè®©å¤§å·æ–‡å­—æœ‰è¶³å¤Ÿçš„å‘¼å¸ç©ºé—´ */
            letter-spacing: 1px;        /* å¢åŠ å­—é—´è·ï¼Œæå‡é«˜çº§æ„Ÿ */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* åŠ è½½ä¸­é®ç½© */
        #loadingOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 10001; 
            justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid #0969da; border-radius: 50%; 
            width: 40px; height: 40px; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å†å²è®°å½•æ¨¡æ€æ¡† */
        #historyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; justify-content: center; align-items: center; }
        #downloadLink { position: absolute; top: 20px; right: 30px; z-index: 100; display: none; }
    </style>
</head>

<body>
    <div id="loginOverlay">
        <div class="login-card">
            <h1>ğŸš€ æ¬¢è¿ï¼</h1>
            <p style="opacity: 0.8;">è¯·é€‰æ‹©ä½ çš„èº«ä»½æ¡£æ¡ˆä»¥ç»§ç»­</p>
            <div class="user-grid">
                <button class="user-btn" onclick="app.auth.selectUser('s1', 'ç‹æµ©æ‡¿')"><span class="user-avatar"></span>ç‹æµ©æ‡¿</button>
                <button class="user-btn" onclick="app.auth.selectUser('s2', 'ç‹ç‰§è™¹')"><span class="user-avatar"></span>ç‹ç‰§è™¹</button>
                <button class="user-btn" onclick="app.auth.selectUser('s3', 'é™ˆå¦¤ä½•')"><span class="user-avatar"></span>é™ˆå¦¤ä½•</button>
                <button class="user-btn" onclick="app.auth.selectUser('s4', 'åŒä¼´ D')"><span class="user-avatar"></span>åŒä¼´ D</button>
                <button class="user-btn" onclick="app.auth.selectUser('s5', 'åŒä¼´ E')"><span class="user-avatar"></span>åŒä¼´ E</button>
                <button class="user-btn" onclick="app.auth.selectUser('s6', 'åŒä¼´ F')"><span class="user-avatar"></span>åŒä¼´ F</button>
                <button class="user-btn" onclick="app.auth.selectUser('s7', 'åŒä¼´ G')"><span class="user-avatar"></span>åŒä¼´ G</button>
                <button class="user-btn" onclick="app.auth.selectUser('s8', 'é»˜è®¤')"><span class="user-avatar"></span>é»˜è®¤</button>
            </div>
        </div>
    </div>

    <div id="bgLayer"></div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #333; font-weight: bold;">MISTRAL AI æ­£åœ¨è¿›è¡Œç‰ˆé¢åˆ†æä¸è½¬æ¢...</p>
        <p style="font-size: 12px; color: #666;">ç”±äºPDFä¸ºAIè§†è§‰è¯»å–ï¼Œå¤§æ–‡ä»¶å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿï¼Œè¯·æ­‡æ­‡è„šï¼Œä¸è¦åˆ·æ–°å“¦</p>
    </div>

    <div class="editor-container" id="leftPane">
        <div class="header">
            <span class="header-title">è®ºæ–‡é˜…è¯»å™¨</span>
            <div class="btn-group">
                <input type="file" id="pdfInput" accept=".pdf,.png,.jpg,.jpeg" multiple style="display:none">
                <input type="file" id="bgInput" accept=".png,.jpg,.jpeg,.webp" style="display:none">

                <div class="setting-box" id="translationPreset">
                    <label class="toggle-container">
                        <input type="checkbox" id="translateToggle">
                        <span class="toggle-card">
                            <i class="icon-translate"></i>
                            <span class="status-text">Deepseek ç¿»è¯‘ï¼š<span id="toggleStatus">å…³é—­</span></span>
                        </span>
                    </label>
                </div>

                <button class="btn btn-picture" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸ å£çº¸</button>
                <button class="btn btn-primary" onclick="app.ui.openHistoryModal()">ğŸ“‚ å†å²è®°å½•</button>
                <button class="btn btn-accent" id="uploadBtn" onclick="document.getElementById('pdfInput').click()">â˜ï¸ PDFè¯†åˆ«</button>
            </div>
        </div>

        <textarea id="source" placeholder="æ”¯æŒæ‹–æ‹½ä¸Šä¼  PDF/å›¾ç‰‡/Markdown..." oninput="app.render.run()"></textarea>
        <div id="pdfViewer"></div>
        
        <div id="footerControl">
            <div class="font-control" title="è°ƒæ•´å³ä¾§é¢„è§ˆåŒºå­—ä½“å¤§å°">
                <span>å­—ä½“å¤§å°:</span>
                <input type="range" id="fontSizeSlider" min="12" max="24" value="16" step="1">
                <span id="fontSizeVal">16px</span>
            </div>
        </div>
    </div>

    <div class="resizer" id="dragHandle"></div>

    <div class="preview-container markdown-body" id="preview">
        <a id="downloadLink" class="btn btn-primary" href="#">ğŸ’¾ ä¸‹è½½ Markdownæ–‡ä»¶</a>
        <div id="previewContent"></div>
    </div>

    <div id="historyModal">
        <div style="background: white; width: 500px; max-height: 60%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <div style="padding: 15px; background: #f6f8fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">ğŸ“œ å†å²æ–‡æ¡£åº“</h3>
                <button onclick="document.getElementById('historyModal').style.display='none'" style="border: none; background: none; cursor: pointer; font-size: 20px;">Ã—</button>
            </div>
            <div id="historyList" style="flex: 1; overflow-y: auto; padding: 10px;">
                <p style="text-align: center; color: #666;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // ğŸ”´ å…¨å±€å‘½åç©ºé—´ä¸é…ç½® (State Management)
        // ============================================================================
        const app = {
            state: {
                currentUser: 's1',
                currentUserName: 'é˜Ÿé•¿',
                currentMdPath: null,    // è®°å½• GitHub ä¸Šçš„ MD è·¯å¾„
                originalMdContent: "",  // ç¼“å­˜åŸæ–‡ï¼Œç”¨äºå…³é—­ç¿»è¯‘æ—¶å›é€€
                pdfDoc: null,
                pageHeights: [],        // æ¯ä¸€é¡µ PDF é«˜åº¦ï¼Œç”¨äºåŒæ­¥æ»šåŠ¨
                lastSyncedPage: 1
            },
            
            // DOM å…ƒç´ ç¼“å­˜
            dom: {
                source: document.getElementById('source'),
                preview: document.getElementById('preview'),
                previewContent: document.getElementById('previewContent'),
                pdfViewer: document.getElementById('pdfViewer'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                uploadBtn: document.getElementById('uploadBtn'),
                downloadLink: document.getElementById('downloadLink'),
                translateToggle: document.getElementById('translateToggle')
            },

            // Markdown å¼•æ“åˆå§‹åŒ–
            md: window.markdownit({ html: true, breaks: true, linkify: true })
                .use(texmath, { engine: katex, delimiters: 'dollars', katexOptions: { trust: true, strict: false } })
        };

        // ============================================================================
        // ğŸ”µ æ¨¡å— 1ï¼šèº«ä»½éªŒè¯ä¸ç”¨æˆ·ç³»ç»Ÿ (Auth Module)
        // ============================================================================
        app.auth = {
            selectUser: (id, name) => {
                app.state.currentUser = id;
                app.state.currentUserName = name;
                
                // ç•Œé¢åé¦ˆ
                const overlay = document.getElementById('loginOverlay');
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
                
                document.title = `æ–‡æ¡£é˜…è¯»å™¨ - ${name}`;
                document.querySelector('.header-title').innerText = `è®ºæ–‡é˜…è¯»å™¨`;
                console.log(`âœ… èº«ä»½å·²ç¡®è®¤ä¸º: ${name} (${id})`);

                // ==================== ğŸŸ¢ æ–°å¢ï¼šè§¦å‘åå°é¢„åŠ è½½ ====================
                fetch('/history/preload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user: id })
                }).catch(e => console.warn("é¢„åŠ è½½è§¦å‘å¤±è´¥", e));
            }
        };

        // ============================================================================
        // ğŸ”µ æ¨¡å— 2ï¼šæ¸²æŸ“æ ¸å¿ƒ (Rendering Engine - Markdown & Clean)
        // ============================================================================
        app.render = {
            run: () => {
                // æ‰§è¡Œæ¸…æ´—ä¸æ¸²æŸ“
                const cleanText = app.render.smartClean(app.dom.source.value);
                app.dom.previewContent.innerHTML = app.md.render(cleanText);

                // æ¸²æŸ“æ•°å­¦å…¬å¼ (KaTeX è‡ªåŠ¨æ¸²æŸ“)
                if (window.renderMathInElement) {
                    renderMathInElement(app.dom.previewContent, { 
                        delimiters: [
                            {left: "$$", right: "$$", display: true}, 
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false, strict: false, trust: true
                    });
                }
            },
            // æ ¸å¿ƒï¼šæ–‡æœ¬æ¸…æ´—ä¸ LaTeX å®¹é”™é€‚é… (è§£å†³ OCR ä¹±ç å’Œå…¬å¼å˜çº¢)
            smartClean: (content) => {
                if (!content) return "";
                let clean = content;

                // --- ğŸŸ¢ æ­¥éª¤ 1ï¼šå…¨å±€æ¸…ç†å…¬å¼å—å¤–éƒ¨çš„å­¤ç«‹å¼•ç”¨ç¬¦ ---
                // å¾ˆå¤šæ—¶å€™ç¿»è¯‘æ’ä»¶ä¼šåœ¨ä¸¤ä¸ª $$ ä¹‹é—´åŠ ä¸€ä¸ª > ï¼Œå…ˆæŠŠå®ƒå¹²æ‰
                clean = clean.replace(/\$\$\s*>\s*\$\$/g, '');

                // --- ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡â€œä¿é™©ç®±â€éš”ç¦» (é˜²æ­¢æ³„éœ²ä¸å¹²æ‰°) ---
                const imgVault = [];
                clean = clean.replace(/!\[.*?\]\(data:image\/.*?;base64,.*?\)/g, (match) => {
                    imgVault.push(match);
                    return `__IMG_HOLDER_${imgVault.length - 1}__`; // æš‚æ—¶ç”¨å ä½ç¬¦æ›¿ä»£
                });

                // --- 2. ç‰©ç†æ¸…é™¤ï¼šæ— ç”¨è¡Œä¸å™ªå£° (PDF/OCR æ®‹ç•™) ---
                // A. ç§»é™¤å­¤ç«‹çš„æ•°å­—è¡Œ (1-4ä½æ•°å­—ï¼Œå¦‚é¡µç  1 æˆ–å¹´ä»½ 19xx)
                clean = clean.replace(/^\s*\d{1,4}\s*$/gm, '');
                // B. ç§»é™¤ OCR äº§ç”Ÿçš„è£…é¥°æ€§æ¨ªçº¿æˆ–ç°çº¿
                clean = clean.replace(/^\s*[-_]{3,}\s*$/gm, '');
                // C. ç§»é™¤å­¤ç«‹çš„ç‰¹æ®Šç¬¦å·è¡Œ
                clean = clean.replace(/^\s*[â†ª\u21aa]\s*$/gm, '');

                // B. ç§»é™¤ç©ºçš„ç¿»è¯‘æ¡ (åªæœ‰ ">" çš„è¡Œ)
                clean = clean.replace(/^>\s*$/gm, '');

    

                // 1. ğŸŸ¢ åŸºç¡€ç¬¦å·è¿˜åŸ
                const entityMap = {
                    '&lt;': '<', '&gt;': '>', '&amp;': '&',
                    '&le;': '\\le', '&ge;': '\\ge', '&plusmn;': '\\pm',
                    '&amp;lt;': '<', '&amp;gt;': '>', '&amp;amp;lt;': '<'
                };
                Object.keys(entityMap).forEach(key => {
                    clean = clean.split(key).join(entityMap[key]);
                });
                
                // 1. ç»“æ„åŒ–ï¼šé¡µé¢åˆ†éš”ç¬¦è½¬ä¸ºéšå½¢é”šç‚¹
                // --- ğŸŸ¢ ç»“æ„åŒ–ä¿®å¤ï¼šç²¾å‡†å¤„ç†é¡µé¢åˆ†éš”ç¬¦ (é˜²æ­¢ 1,3,5 è·³å˜) ---
                // 1. å…ˆå°†æ‰€æœ‰å¯èƒ½çš„å˜ä½“ç»Ÿä¸€åŒ–
                clean = clean.replace(/\[\[\s*PAGE_BREAK\s*\]\]/g, '[[PAGE_BREAK]]');

                // 2. æ ¸å¿ƒå»é‡ï¼šå¦‚æœåœ¨å¾ˆçŸ­çš„è·ç¦»å†…ï¼ˆæ¯”å¦‚ 500 å­—å†…ï¼‰å‡ºç°äº†ä¸¤ä¸ª PAGE_BREAKï¼Œé€šå¸¸æ˜¯åŒè¯­é‡å¤ï¼Œåˆ æ‰ç¬¬äºŒä¸ª
                // æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶æ•°ç»„æ¥è®°å½• marker ä½ç½®ï¼Œè¿›è¡Œè·ç¦»æ ¡éªŒ
                let lastMarkerPos = -1;
                clean = clean.replace(/\[\[PAGE_BREAK\]\]/g, (match, offset) => {
                    // å¦‚æœä¸¤ä¸ªåˆ†éš”ç¬¦è·ç¦»å°äº 100 å­—ç¬¦ï¼ˆè¯´æ˜æ˜¯ç´§æŒ¨ç€çš„åŸæ–‡/è¯‘æ–‡åˆ†éš”ç¬¦ï¼‰ï¼Œåªä¿ç•™ä¸€ä¸ª
                    if (lastMarkerPos !== -1 && (offset - lastMarkerPos) < 100) {
                        return ""; 
                    }
                    lastMarkerPos = offset;
                    return match;
                });

                // 3. æœ€åè½¬æ¢ä¸ºéšè—çš„ HTML é”šç‚¹
                clean = clean.replace(/\[\[PAGE_BREAK\]\]/g, 
                    '<div class="sync-page-marker" style="height:1px; width:100%; clear:both; margin-top:10px; visibility:hidden;"></div>');
                
                // --- ğŸŸ¢ é‡ç‚¹ï¼šåªè¦å‡ºç° {array}[] æˆ– {array} [ä»»æ„å†…å®¹]ï¼Œä¸€å¾‹è½¬ä¸ºæ ‡å‡† {array} ---
                // è¿™ä¸ªæ­£åˆ™ä¼šåŒ¹é… {array} åé¢ç´§è·Ÿçš„ä»»ä½•è¢« [] åŒ…è£¹çš„å†…å®¹ï¼Œå¹¶å°†å…¶åˆ æ‰
                clean = clean.replace(/(\{array\})\s*\[[\s\S]*?\]/g, '$1');

                // 2. å…¬å¼å—ä¿®å¤ï¼š\[ ... \] -> $$ ... $$ï¼Œå¹¶æå– (1) ä¸º \tag{1}
                clean = clean.replace(/\\\[([\s\S]*?)\\\]/g, (match, body) => {
                    let formula = body.trim();
                    
                    const tagMatch = formula.match(/\s*\((\d+[\.\d]*)\)$/);
                    if (tagMatch) {
                        let label = tagMatch[1];
                        let pureFormula = formula.replace(/\s*\(\d+[\.\d]*\)$/, '');
                        return '$$ ' + pureFormula + ' \\tag{' + label + '} $$';
                    }
                    return '$$' + formula + '$$';
                });

                // 2. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨å°†å¸¦ç¼–å·çš„å…¬å¼è½¬æ¢ä¸ºç‹¬ç«‹è¡Œå—çº§å…¬å¼
                // åŒ¹é…é€»è¾‘ï¼šæ‰¾ä»¥ $ å¼€å¤´ï¼Œä¸­é—´åŒ…å«å†…å®¹ï¼Œæœ€åä»¥ (æ•°å­—) ç»“å°¾çš„è¡Œ
                // ä¾‹å¦‚ï¼š$\frac{dx}{dt}=...$ (2)  ->  $$\frac{dx}{dt}=... \tag{2}$$
                        
                // æ­£åˆ™è§£æï¼š
                // \$ : åŒ¹é…å¼€å¤´çš„ $
                // ([^$]+) : åŒ¹é…å…¬å¼å†…å®¹ï¼ˆé $ çš„ä»»æ„å­—ç¬¦ï¼‰
                // \$ : åŒ¹é…ç»“å°¾çš„ $
                // \s* : åŒ¹é…å¯é€‰ç©ºæ ¼
                // [\(ï¼ˆ](\d+)[\)ï¼‰] : åŒ¹é… (2) æˆ– ï¼ˆ2ï¼‰ è¿™ç§ç¼–å·
                clean = clean.replace(/\$([^$]+)\$\s*[\(ï¼ˆ](\d+)[\)ï¼‰]/g, (match, formula, num) => {
                    return `\n$$\n${formula} \\tag{${num}}\n$$\n`;
                });

                // 3. æ·±åº¦æ¸…æ´— $$ å†…éƒ¨ (è§£å†³ \left \right ä¸åŒ¹é…å¯¼è‡´çš„çº¢å­—)
                clean = clean.replace(/\$\$([\s\S]*?)\$\$/g, (match, body) => {
                    let fixed = body.trim();
                    // --- ğŸŸ¢ æ”¹è¿›ç‰ˆå»é‡é€»è¾‘ï¼šé˜²æ­¢è¯¯æ€å¤šè¡Œå…¬å¼ ---
                    // é€»è¾‘ï¼šåªæœ‰å½“æ£€æµ‹åˆ°ä¸¤ä¸ªæˆ–æ›´å¤š \tag æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯ OCR é‡å¤è¯†åˆ«ï¼Œæ‰§è¡Œæˆªæ–­
                    const allTags = fixed.match(/\\tag\s*\{\d+[\.\d]*\}/g);
                    if (allTags && allTags.length > 1) {
                        // æ‰¾åˆ°ç¬¬ä¸€ä¸ª \tag çš„ç»“æŸä½ç½®
                        const firstTagMatch = fixed.match(/([\s\S]*?\\tag\s*\{\d+[\.\d]*\})/);
                        if (firstTagMatch) {
                            fixed = firstTagMatch[1];
                            // è¡¥é½å¯èƒ½è¢«æˆªæ‰çš„ç¯å¢ƒé—­åˆç¬¦ (ä¿é™©æªæ–½)
                            if (fixed.includes('\\begin{array}') && !fixed.includes('\\end{array}')) {
                                fixed += ' \\end{array}';
                            }
                        }
                    }


                    // B. åŸºç¡€è¯­æ³•æ¸…ç†ä¸ HTML è¿˜åŸ
                    fixed = fixed.replace(/[\r\n]+/g, ' ').replace(/&amp;/g, '&').replace(/>/g, '');
                    // æš´åŠ›ç§»é™¤ä¸åŒ¹é…çš„å®šç•Œç¬¦
                    fixed = fixed.replace(/\\left\\\|/g, '\\|').replace(/\\right\\\|/g, '\\|') // ä¿®å¤èŒƒæ•° ||
                                .replace(/\\left\(/g, '(').replace(/\\right\)/g, ')')         // ä¿®å¤åœ†æ‹¬å·
                                .replace(/\\left\[/g, '[').replace(/\\right\]/g, ']')         // ä¿®å¤æ–¹æ‹¬å·
                                .replace(/\\left\\\{/g, '\\{').replace(/\\right\\}/g, '\\}')  // ä¿®å¤èŠ±æ‹¬å·
                                .replace(/\\right\.?/g, '')                                  // ç§»é™¤æ®‹ç•™çš„ \right.
                                .replace(/\\left\.?/g, '');
                                
                    // ğŸŸ¢ B. å·®å¼‚åŒ–é—´è·å¤„ç†
                    // é€»è¾‘ï¼šå¦‚æœå…¬å¼ä¸­åŒ…å« matrix å…³é”®å­—ï¼Œåˆ™è§†ä¸ºçŸ©é˜µï¼Œä¿æŒç´§å‡‘ï¼›
                    // å¦åˆ™ï¼Œé’ˆå¯¹åŒ…å« \frac çš„å¤šè¡Œå…¬å¼å¢åŠ é—´è·ã€‚
                    const isMatrix = /matrix|smallmatrix|cases/.test(fixed);

                    if (!isMatrix) {
                        // ä»…é’ˆå¯¹éçŸ©é˜µã€ä¸”åŒ…å«åˆ†å¼çš„å¤šè¡Œå…¬å¼å¢åŠ é—´è·
                        if (fixed.includes('\\frac') || fixed.includes('\\dfrac')) {
                            fixed = fixed.replace(/\\\\/g, '\\\\[0.8em] ');
                        } else {
                            fixed = fixed.replace(/\\\\/g, '\\\\[0.4em] ');
                        }
                    }

                    // C. ç¼–å·äºŒæ¬¡æå–ï¼šå¦‚æœå…¬å¼å†…éƒ¨è¿˜è—ç€ (9)ï¼Œå°†å…¶è½¬ä¸ºæ ‡å‡†çš„ \tag{9}
                    if (!fixed.includes('\\tag')) {
                        const innerTag = fixed.match(/\s*\((\d+[\.\d]*)\)\s*$/);
                        if (innerTag) {
                            fixed = fixed.replace(innerTag[0], '') + ' \\tag{' + innerTag[1] + '}';
                        }
                    }
            
                    // D. æ ¼å¼è§„èŒƒåŒ–ï¼šç§»é™¤ \tag å‰å¤šä½™çš„é€—å·
                    fixed = fixed.replace(/[,ï¼Œã€‚]\s*\\tag/g, ' \\tag');
                    
                    // E. è‡ªåŠ¨è¡¥å…¨ç¯å¢ƒï¼šå¤„ç†æ–¹ç¨‹ç»„æˆ–å¤šè¡Œå¯¹é½
                    if (fixed.includes('\\{') && fixed.includes('\\\\')) {
                        // å¦‚æœåŒ…å«å·¦å¤§æ‹¬å·å’Œæ¢è¡Œï¼Œå¼ºåˆ¶è½¬ä¸º cases ç¯å¢ƒ
                        // 2. ğŸŸ¢ æ ¸å¿ƒä¼˜åŒ–ï¼šå°† \\ æ›¿æ¢ä¸º \\[0.5em] å¢åŠ å‚ç›´é—´è·ï¼Œé˜²æ­¢é‡åˆ
                        let spacedBody = fixed.replace(/\\\\/g, '\\\\[0.3em] ');
                        fixed = '\\begin{cases} ' + fixed.replace(/\\\{/g, '') + ' \\end{cases}';
                    } else if (fixed.includes('&') && !fixed.includes('\\begin')) {
                        // å¦‚æœåŒ…å«å¯¹é½ç¬¦ä½†æ²¡æœ‰ç¯å¢ƒï¼Œå¼ºåˆ¶è½¬ä¸º aligned ç¯å¢ƒ
                        // åŒç†ï¼Œä¸ºå¯¹é½ç¯å¢ƒå¢åŠ å‚ç›´é—´è·
                        let spacedBody = fixed.replace(/\\\\/g, '\\\\[0.3em] ');
                        fixed = '\\begin{aligned} ' + fixed + ' \\end{aligned}';
                    }

                    return '$$' + fixed + '$$';
                });

                // --- 4. è¡Œå†…å…¬å¼ä¿®å¤ ---
                // ç§»é™¤è¡Œå†…å…¬å¼ $ ... $ å†…éƒ¨çš„é¦–å°¾ç©ºæ ¼ï¼Œé˜²æ­¢è§£æå¤±è´¥
                clean = clean.replace(/(\$)( +)([^$\n]+?)( +)(\$)/g, "$$$3$$");

                // --- 5. åƒåœ¾ä¿¡æ¯ä¸è¡¨æ ¼æ¸…ç† ---
                clean = clean.replace(/^Team\s*#.*$/gm, "")                // ç§»é™¤ OCR å›¢é˜Ÿæ ‡è®°
                             .replace(/^Page\s*\d+\s+of\s+\d+.*$/gm, "")  // ç§»é™¤é¡µç 
                             .replace(/<\/table>/gi, "</table>\n\n");     // å¼ºåˆ¶è¡¨æ ¼åæ¢è¡Œ

                // --- 6. å¹¿å‘Šå­—æ®µä¸åƒåœ¾ä¿¡æ¯æ¸…ç† (ç²¾å‡†ç‰ˆ) ---

                // A. ç»„åˆåŒ¹é…ï¼šåœ°åŒºå + æ¨¡å‹å (ä¾‹å¦‚ï¼šå¤©æ´¥æ•°å­¦æ¨¡å‹)
                const regions = 'ä¸Šæµ·|å¤©æ´¥|æ–‡æ±‡|äº‘æ±Ÿ|å¤ªæ±Ÿ|äº‘è®¡|äº¤å¾€|æ•°å­¦é™¢æ‰€';
                const models = 'æ•°å­¦æ¨¡å‹|æ•°å­—æ¨¡å‹|ä¸Šæµ·|å¤©æ´¥|æ–‡æ±‡|äº‘æ±Ÿ|å¤ªæ±Ÿ|äº‘è®¡|äº¤å¾€|æ•°å­¦é™¢æ‰€';
                const combinedRegex = new RegExp(`^.*(${regions})\\s*(${models}).*$`, 'gm');

                // B. ç‰¹å¾åŒ¹é…ï¼šåªè¦åŒ…å«è¿™äº›è¯ï¼Œæ•´è¡Œé€šå¸¸éƒ½æ˜¯å¹¿å‘Š (ä¾‹å¦‚ï¼šè·å–æ›´å¤šèµ„è®¯)
                const adFeatures = 'èµ„è®¯|æ•°å­¦æ¨¡å‹|æ•°å­—æ¨¡å‹|ä¸Šæµ·|å¤©æ´¥|æ–‡æ±‡|äº‘æ±Ÿ|å¤ªæ±Ÿ|äº‘è®¡|äº¤å¾€|æ•°å­¦é™¢æ‰€|åœ‹ç«‹è‡ºç£å¤§å­¸|æ–‡æ±Ÿ';
                const featureRegex = new RegExp(`^.*(${adFeatures}).*$`, 'gm');

                clean = clean.replace(combinedRegex, "")  // åªæœ‰ åœ°åŒº+æ¨¡å‹ åŒæ—¶å‡ºç°æ‰åˆ 
                             .replace(featureRegex, "")   // åŒ…å«â€œè·å–æ›´å¤šèµ„è®¯â€ç›´æ¥åˆ 
                             .replace(/^Team\s*#.*$/gm, "") 
                             .replace(/^Page\s*\d+\s+of\s+\d+.*$/gm, "")
                             .replace(/\n{3,}/g, "\n\n")
                             .replace(/<\/table>/gi, "</table>\n\n");

                // --- ğŸŸ¢ ç¬¬å››æ­¥ï¼šä»â€œä¿é™©ç®±â€å–å›å›¾ç‰‡ ---
                imgVault.forEach((imgRaw, index) => {
                    clean = clean.replace(`__IMG_HOLDER_${index}__`, imgRaw);
                });

                return clean.trim();
            }
        };

        // ============================================================================
        // ğŸ”µ æ¨¡å— 3ï¼šPDF å¼•æ“ (PDF Engine - Viewer & Sync)
        // ============================================================================
        app.pdf = {
            // æ¸²æŸ“ PDF æ–‡ä»¶æˆ– URL
            render: async (fileOrUrl) => {
                // ğŸŸ¢ 1. å¢åŠ é˜²å¾¡æ€§æ ¡éªŒ
                if (!fileOrUrl) {
                    return;
                }

                const viewer = app.dom.pdfViewer;
                app.dom.source.style.display = 'none';
                viewer.style.display = 'block';
                viewer.innerHTML = ''; 
                app.state.pageHeights = [];

                let docUrl = typeof fileOrUrl === 'string' ? fileOrUrl : URL.createObjectURL(fileOrUrl);
                
                // åŠ è½½ PDF (æŒ‡å®š cMapUrl æ”¯æŒä¸­æ–‡)
                const loadingTask = pdfjsLib.getDocument({
                    url: docUrl,
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                    cMapPacked: true,
                });
                app.state.pdfDoc = await loadingTask.promise;

                // é€é¡µæ¸²æŸ“
                for (let pageNum = 1; pageNum <= app.state.pdfDoc.numPages; pageNum++) {
                    const page = await app.state.pdfDoc.getPage(pageNum);
                    const originalViewport = page.getViewport({ scale: 1 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.id = `pdf-page-${pageNum}`;
                    // å…³é”®ï¼šCanvas å®½åº¦è®¾ä¸ºåŸå§‹å®½åº¦ï¼Œé€šè¿‡ CSS æ§åˆ¶ç¼©æ”¾
                    canvas.width = page.getViewport({ scale: 1.5 }).width;
                    canvas.height = page.getViewport({ scale: 1.5 }).height;
                    canvas.style.width = `${originalViewport.width}px`; 
                    canvas.style.margin = "0 auto 3px auto";
                    canvas.style.display = "block";

                    await page.render({ canvasContext: context, viewport: page.getViewport({ scale: 1.5 }) }).promise;
                    viewer.appendChild(canvas);
                    app.state.pageHeights.push(canvas.clientHeight + 15);
                }
                
                app.pdf.bindSyncScroll();
            },


            // é‡æ–°è®¾è®¡çš„åŒæ­¥æ»šåŠ¨ç›‘å¬
            bindSyncScroll: () => {
                const preview = app.dom.preview;
                const pdfViewer = app.dom.pdfViewer;
                let isScrolling = false;

                preview.addEventListener('scroll', () => {
                    if (isScrolling) return;

                    const markers = Array.from(preview.querySelectorAll('.sync-page-marker'));
                    if (!markers.length || pdfViewer.style.display === 'none') return;
                
                    const previewScrollTop = preview.scrollTop;
                    // ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šå°†è§¦å‘ç‚¹è®¾ç½®åœ¨é¢„è§ˆçª—å£é«˜åº¦çš„ 30% å¤„
                    // è¿™æ ·å½“æ ‡å¿—çº¿è¿›å…¥ä½ è§†é‡çš„ä¸­ä¸Šéƒ¨æ—¶ï¼ŒPDF å°±ä¼šæå‰ç¿»é¡µ
                    const triggerPoint = previewScrollTop + (preview.clientHeight * 0.3); 
                
                    let activeIndex = 0;
                    for (let i = 0; i < markers.length; i++) {
                        if (markers[i].offsetTop <= triggerPoint) {
                            activeIndex = i;
                        } else {
                            break;
                        }
                    }
                
                    const currentMarker = markers[activeIndex];
                    const nextMarker = markers[activeIndex + 1];
                    const currentPageNum = activeIndex + 1;
                
                    let progress = 0;
                
                    isScrolling = true;
                    app.pdf.smoothSync(currentPageNum, progress);

                    setTimeout(() => { isScrolling = false; }, 30);
                });
            },

            smoothSync: (pageNum, progress) => {
                const viewer = app.dom.pdfViewer;
                const currentPageElement = document.getElementById(`pdf-page-${pageNum}`);
                        
                // åªæœ‰å½“é¡µç çœŸçš„å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰æ‰§è¡Œè·³è½¬ï¼Œä¿ç•™ç”¨æˆ·åœ¨é¡µé¢å†…çš„é˜…è¯»è‡ªä¸»æƒ
                if (currentPageElement && app.state.lastSyncedPage !== pageNum) {
                    app.state.lastSyncedPage = pageNum;
                
                    viewer.scrollTo({
                        top: currentPageElement.offsetTop,
                        behavior: 'smooth' // ä½¿ç”¨å¹³æ»‘æ»šåŠ¨ï¼Œä¸å¹²æ‰°è§†çº¿
                    });
                }
            }
        };

        // ============================================================================
        // ğŸ”µ æ¨¡å— 4ï¼šç½‘ç»œä¸ API äº¤äº’ (Network Module)
        // ============================================================================
        app.network = {
            // å¤„ç†æ–‡ä»¶ä¸Šä¼ ä¸ OCR
            handleOCRUpload: async (file, current, total) => {

                const isTranslationMode = app.dom.translateToggle.checked;

                // UI çŠ¶æ€æ›´æ–°
                app.ui.setLoading(true, 
                    total > 1 ? `[${current}/${total}] æ­£åœ¨è¯†åˆ«: ${file.name}` : "Mistral AI æ­£åœ¨æé€Ÿé˜…è¯»...",
                    "PDF è§†è§‰è¯»å–ä¸­ï¼Œè¯·ç¨å€™...");
                
                app.dom.uploadBtn.disabled = true;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('user', app.state.currentUser);

                try {
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    if (!res.ok) throw new Error(res.statusText);
                    const result = await res.json();

                    // æ›´æ–°çŠ¶æ€
                    app.state.currentMdPath = result.gh_path;
                    app.state.originalMdContent = result.markdown;
                    app.dom.source.value = result.markdown;
                    
                    // æ¸²æŸ“
                    app.render.run();
                    setTimeout(() => app.pdf.render(file), 100); // å¼‚æ­¥æ¸²æŸ“ PDF

                    // è®¾ç½®ä¸‹è½½é“¾æ¥
                    if (result.download_url) {
                        app.dom.downloadLink.href = result.download_url;
                        app.dom.downloadLink.style.display = 'block';
                    }

                    // 2. æ ¹æ®ä¸Šä¼ å‰çš„é¢„è®¾çŠ¶æ€å†³å®šæ˜¯å¦ç¿»è¯‘
                    if (isTranslationMode) {
                        await app.network.performTranslation(result.gh_path);
                    }

                } catch (err) {
                    alert("è¯†åˆ«å¤±è´¥: " + err.message);
                } finally {
                    if (current === total) {
                        app.ui.setLoading(false);
                        app.dom.uploadBtn.disabled = false;
                    }
                }
            },

            // // ç¿»è¯‘åŠŸèƒ½
            // handleTranslationToggle: async () => {
            //     const isChecked = app.dom.translateToggle.checked;
            //     if (!isChecked) {
            //         // å…³é—­ï¼šå›é€€åˆ°åŸæ–‡
            //         if (app.state.originalMdContent) {
            //             app.dom.source.value = app.state.originalMdContent;
            //             app.render.run();
            //         }
            //     } else {
            //         // å¼€å¯ï¼šè°ƒç”¨ API
            //         if (app.state.currentMdPath) await app.network.performTranslation(app.state.currentMdPath);
            //     }
            // },

            performTranslation: async (ghPath) => {
                if (!ghPath) return;
                app.ui.setLoading(true, "æ­£åœ¨è°ƒç”¨ DeepSeek è¿›è¡Œå­¦æœ¯ç¿»è¯‘...", "æ­£åœ¨ä¿æŠ¤å…¬å¼å¹¶é‡ç»„åŒè¯­æ®µè½ï¼Œå¯èƒ½éœ€è¦1-2åˆ†é’Ÿ...");
                
                try {
                    const res = await fetch('/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ path: ghPath })
                    });
                    const data = await res.json();
                    app.dom.source.value = data.content;
                    app.render.run();
                } catch (err) {
                    alert("ç¿»è¯‘å¤±è´¥: " + err.message);
                    app.dom.translateToggle.checked = false;
                } finally {
                    app.ui.setLoading(false);
                }
            },

            // å†å²è®°å½•åˆ—è¡¨
            fetchHistory: async () => {
                const listContainer = document.getElementById('historyList');
                listContainer.innerHTML = '<p style="text-align: center;">æ­£åœ¨åŒæ­¥ GitHub...</p>';
                try {
                    const res = await fetch(`/history/list?user=${app.state.currentUser}`);
                    const list = await res.json();
                    if (!list.length) {
                        listContainer.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— è®°å½•</p>';
                        return;
                    }
                    
                    listContainer.innerHTML = '';
                    list.forEach(item => {
                        const div = document.createElement('div');
                        div.style.cssText = "padding: 12px; border-bottom: 1px solid #eee; cursor: pointer;";
                        div.onmouseover = () => div.style.background = "#f0f8ff";
                        div.onmouseout = () => div.style.background = "white";
                        // ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–­ timestamp æ˜¯å¦å¤§äº 0
                        // å¦‚æœæ˜¯ 0ï¼ˆåç»­è®°å½•ï¼‰ï¼Œåˆ™åªæ˜¾ç¤ºåç§°ï¼›å¦åˆ™æ˜¾ç¤ºåç§° + æ—¶é—´
                        const timeHtml = item.timestamp > 0 
                            ? `<div style="font-size:12px;color:#888;">${new Date(item.timestamp * 1000).toLocaleString()}</div>` 
                            : '';

                        // åœ¨å¾ªç¯ç”Ÿæˆåˆ—è¡¨é¡¹æ—¶ä¿®æ”¹ HTML
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div onclick="app.network.loadHistoryItem(event, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    <b>${item.name}</b>
                                    ${timeHtml}
                                </div>
                                <button class="delete-btn" onclick="app.network.deleteItem(event, '${item.pdf_path}', '${item.md_path}')">ğŸ—‘ï¸</button>
                            </div>
                        `;

                        div.onclick = () => app.network.loadHistoryItem(item);
                        listContainer.appendChild(div);
                    });
                } catch (e) { listContainer.innerHTML = "åŠ è½½å¤±è´¥"; }
            },

            loadHistoryItem: async (item) => {
                document.getElementById('historyModal').style.display = 'none';

                // æ‰“å¼€å†å²æ–‡æ¡£æ—¶ï¼Œå…³é—­ç¿»è¯‘å¼€å…³å¹¶é”å®š
                app.dom.translateToggle.checked = false;

                app.ui.setLoading(true, "æ­£åœ¨ä»äº‘ç«¯æ‹‰å–...", "æ•°æ®æ¥è‡ª GitHub æ¡£æ¡ˆåº“ï¼ˆå·¦ä¾§PDFåæ‹‰å–ï¼Œå¯èƒ½ä¼šæ…¢ä¸€ç‚¹ï¼‰");
                
                app.state.currentMdPath = item.md_path;
                app.dom.translateToggle.checked = false;

                try {
                    const mdText = await (await fetch(item.md_url)).text();
                    app.state.originalMdContent = mdText;
                    app.dom.source.value = mdText;
                    app.render.run();
                    
                    window.requestAnimationFrame(() => app.pdf.render(item.pdf_url));
                } catch (e) { alert("åŠ è½½å¤±è´¥"); } 
                finally { app.ui.setLoading(false); }
            },

            deleteItem: async (event, pdfPath, mdPath) => {
                event.stopPropagation(); // é˜²æ­¢è§¦å‘åŠ è½½æ–‡æ¡£äº‹ä»¶
                        
                if (!confirm("ç¡®å®šè¦å½»åº•åˆ é™¤è¯¥æ–‡æ¡£è®°å½•åŠå…¶äº‘ç«¯å¤‡ä»½å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
                        
                app.ui.setLoading(true, "æ­£åœ¨ä» GitHub æ°¸ä¹…æŠ¹é™¤æ•°æ®...", "åŒæ­¥æ›´æ–°æ¡£æ¡ˆåº“ä¸­...");
                        
                try {
                    const res = await fetch('/history/delete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user: app.state.currentUser,
                            pdf_path: pdfPath,
                            md_path: mdPath
                        })
                    });
                    
                    if (res.ok) {
                        alert("åˆ é™¤æˆåŠŸ");
                        app.network.fetchHistory(); // é‡æ–°æ‹‰å–åˆ—è¡¨
                    } else {
                        throw new Error("åˆ é™¤å¤±è´¥");
                    }
                } catch (e) {
                    alert(e.message);
                } finally {
                    app.ui.setLoading(false);
                }
            }
        };

        // ============================================================================
        // ğŸ”µ æ¨¡å— 5ï¼šUI äº¤äº’ä¸åˆå§‹åŒ– (UI & Init)
        // ============================================================================
        app.ui = {
            setLoading: (show, msg1, msg2) => {
                const el = app.dom.loadingOverlay;
                el.style.display = show ? 'flex' : 'none';
                if (show && msg1) {
                    const ps = el.querySelectorAll('p');
                    if (ps[0]) ps[0].innerText = msg1;
                    if (ps[1]) ps[1].innerText = msg2 || "";
                }
            },
            
            openHistoryModal: () => {
                document.getElementById('historyModal').style.display = 'flex';
                app.network.fetchHistory();
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // 1. è®¾ç½®é»˜è®¤æ¬¢è¿è¯­
            app.dom.source.value = "# æ¬¢è¿ä½¿ç”¨è®ºæ–‡é˜…è¯»å™¨\n\nè¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºæˆ‘ä»¬å°é˜Ÿæ‰“é€ çš„**å…¨èƒ½æ–‡æ¡£è§£æä¸é˜…è¯»å¹³å°**ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è½»æ¾å°†è‹±æ–‡PDFè®ºæ–‡è½¬æ¢ä¸ºé«˜è´¨é‡çš„ Markdownæ–‡æœ¬ï¼Œå¹¶æ­é…**æ²‰æµ¸å¼ç¿»è¯‘**æµè§ˆå™¨æ’ä»¶(æ¨è)æˆ–ä½¿ç”¨å¼€å‘çš„`Deepseekç¿»è¯‘`è¿›è¡Œç¿»è¯‘ã€‚\n\n **âœ¨æ ¸å¿ƒåŠŸèƒ½ä¸€è§ˆ**\n\n1.**â˜ï¸ æ™ºèƒ½ PDF è¯†åˆ«**\n ç‚¹å‡»ä¸Šæ–¹çš„`â˜ï¸ PDFè¯†åˆ«`æŒ‰é’®ï¼Œä¸Šä¼ ä½ çš„ PDFæ–‡ä»¶ã€‚\n**æ¨¡å‹é©±åŠ¨**ï¼šåˆ©ç”¨ Mistral AIå¤§æ¨¡å‹é€šè¿‡è§†è§‰OCRè¿›è¡Œæ·±åº¦ç‰ˆé¢åˆ†æã€‚\n**å…¬å¼è¿˜åŸ**ï¼šå®Œç¾æ”¯æŒ LaTeX æ•°å­¦å…¬å¼ï¼Œå¦‚ $\\oint_C \\mathbf{F} \\cdot d\\mathbf{r} = \\iint_S (\\nabla \\times \\mathbf{F}) \\cdot d\\mathbf{S}$ã€‚\n**å›¾æ–‡å¹¶èŒ‚**ï¼šå›¾ç‰‡ä¼šè‡ªåŠ¨åµŒå…¥æ–‡æ¡£ï¼Œæ— éœ€æ‹…å¿ƒä¸¢å¤±ã€‚\n\n2.**ğŸ“œ å†å²æ¡£æ¡ˆåº“**\n ç‚¹å‡»`ğŸ“‚ å†å²è®°å½•`ï¼Œéšæ—¶å›æº¯ä½ çš„æ–‡æ¡£ã€‚\n**å†å²è®°å½•**ï¼šæ¯ä½æˆå‘˜æ‹¥æœ‰ç‹¬ç«‹çš„å†å²è®°å½•ã€‚\n**äº‘ç«¯å­˜å‚¨**ï¼šè§£æè¿‡çš„æ–‡æ¡£ä¼šè‡ªåŠ¨å½’æ¡£è‡³ GitHubæ¡£æ¡ˆåº“ï¼Œæ°¸ä¸ä¸¢å¤±ã€‚\n**å¿«é€ŸåŠ è½½**ï¼šæ— éœ€é‡æ–°è§£æï¼Œç‚¹å‡»å³çœ‹ã€‚\n\n3.**ğŸ”„ åŒå±åŒæ­¥é˜…è¯»**\nå·¦ä¾§æ˜¾ç¤º PDF åŸæ–‡ï¼Œå³ä¾§æ˜¾ç¤ºè§£æåçš„ Markdownã€‚\n**åŒæ­¥æ»šåŠ¨**ï¼šæ»šåŠ¨å³ä¾§ç¬”è®°ï¼Œå·¦ä¾§ PDF ä¼šè‡ªåŠ¨ç¿»é¡µè·Ÿéšã€‚\n**å¯¹ç…§æ£€æŸ¥**ï¼šç²¾å‡†å®šä½åŸæ–‡ï¼Œé˜²æ­¢ä¿¡æ¯é—æ¼ã€‚\n\n4.**ğŸŒ å¤§æ¨¡å‹åŒè¯­ç¿»è¯‘**\nç‚¹å‡»é¡¶éƒ¨çš„`Deepseekç¿»è¯‘`å³å¯å¼€å¯ç¿»è¯‘é¢„è®¾æ¨¡å¼ï¼ˆç¿»è¯‘å³å°†ä¸Šä¼ çš„PDFè®ºæ–‡ï¼‰ã€‚è¯¥åŠŸèƒ½æ”¯æŒâ€œè¿ç»­é˜…è¯»â€éœ€æ±‚ï¼šä½ å¯ä»¥åœ¨é˜…è¯»å½“å‰æ–‡æ¡£æ—¶æå‰å‹¾é€‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ¥ä¸‹æ¥ä¸Šä¼ çš„æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆä¸­è‹±åŒè¯­å¯¹ç…§ã€‚\n\n**ğŸ® å¿«æ·æ“ä½œæŒ‡å—**\n**å­—ä½“è°ƒæ•´**ï¼šä½¿ç”¨åº•éƒ¨çš„æ»‘å—è°ƒæ•´å­—å·ï¼Œä¿æŠ¤è§†åŠ›ã€‚\n**å…¨å±é˜…è¯»**ï¼šæ‹–æ‹½ä¸­é—´çš„åˆ†éš”æ¡ï¼Œè‡ªç”±è°ƒæ•´å·¦å³çª—å£æ¯”ä¾‹ã€‚\n**ä¸‹è½½ç¬”è®°**ï¼šç‚¹å‡»å³ä¾§çš„`ğŸ’¾ ä¸‹è½½ Markdown`ï¼Œå°†è§£æåçš„Markdownæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ã€‚ \n**ä¸ªæ€§å£çº¸**ï¼šç‚¹å‡» `ğŸ–¼ï¸ æ¢å£çº¸` æŒ‰é’®å¯ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡ï¼ˆå»ºè®®ä¸ºäº®è‰²å›¾ç‰‡ï¼‰ï¼Œæ‰“é€ ä¸“å±é˜…è¯»ç©ºé—´ã€‚\n**åŒºåŸŸè°ƒæ•´**ï¼šæ‹–æ‹½ä¸­é—´çš„ç°è‰²åˆ†éš”æ¡ï¼Œå³å¯è°ƒæ•´å·¦å³ä¾§ï¼ˆPDF å’Œ Markdownï¼‰çš„åŒºåŸŸå¤§å°ã€‚\n**æ‹–åŠ¨ä¸Šä¼ **ï¼šæ”¯æŒæ‹–åŠ¨PDFæ–‡ä»¶åˆ°ç½‘é¡µï¼Œä»è€Œä¸Šä¼ PDFæ–‡ä»¶ã€‚\n\næç¤ºï¼šä¸Šä¼ çš„æ–‡ä»¶å°†è‡ªåŠ¨å½’æ¡£è‡³ä½ çš„ä¸“å±ç›®å½•ã€‚\n\nå¼€å§‹ä½ çš„é˜…è¯»ä¹‹æ—…å§ï¼ ";
            app.render.run();

            // 2. ç»‘å®šæ–‡ä»¶è¾“å…¥
            document.getElementById('pdfInput').addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                
                if (files.length > 1 && !confirm(`å³å°†æ‰¹é‡è¯†åˆ« ${files.length} ä¸ªæ–‡ä»¶ï¼Ÿ`)) return;
                
                for (let i = 0; i < files.length; i++) {
                    await app.network.handleOCRUpload(files[i], i + 1, files.length);
                }
                e.target.value = '';
            });

            // åœ¨ app.init æˆ–é¡µé¢åŠ è½½æ—¶æ·»åŠ 
            document.getElementById('translateToggle').addEventListener('change', function(e) {
                const statusText = document.getElementById('toggleStatus');
                statusText.innerText = e.target.checked ? "å¼€å¯" : "å…³é—­";
            });

            // 3. å­—ä½“æ»‘å—
            document.getElementById('fontSizeSlider').addEventListener('input', (e) => {
                app.dom.preview.style.fontSize = `${e.target.value}px`;
                document.getElementById('fontSizeVal').textContent = `${e.target.value}px`;
            });

            // 4. æ‹–æ‹½æ”¯æŒ
            const body = document.body;
            ['dragenter','dragover'].forEach(e => body.addEventListener(e, (ev) => { ev.preventDefault(); body.classList.add('drag-over'); }));
            ['dragleave','drop'].forEach(e => body.addEventListener(e, (ev) => { ev.preventDefault(); body.classList.remove('drag-over'); }));
            
            body.addEventListener('drop', async (e) => {
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.match(/\.(pdf|jpg|png)$/i));
                if (files.length && confirm(`ç¡®è®¤ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶ï¼Ÿ`)) {
                    for (let i = 0; i < files.length; i++) await app.network.handleOCRUpload(files[i], i+1, files.length);
                }
            });

            // 5. å·¦å³åˆ†æ æ‹–æ‹½
            const resizer = document.getElementById('dragHandle');
            const leftPane = document.getElementById('leftPane');
            let isResizing = false;
            resizer.addEventListener('mousedown', () => { isResizing = true; body.style.cursor = 'col-resize'; });
            document.addEventListener('mousemove', e => { if (isResizing) leftPane.style.width = (e.clientX / window.innerWidth) * 100 + '%'; });
            document.addEventListener('mouseup', () => { isResizing = false; body.style.cursor = 'default'; });

            // 6. æ¢å£çº¸é€»è¾‘
            document.getElementById('bgInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const bgLayer = document.getElementById('bgLayer');
                        // å°†è¯»å–åˆ°çš„å›¾ç‰‡è®¾ç½®ä¸ºèƒŒæ™¯
                        bgLayer.style.backgroundImage = `url('${event.target.result}')`;
                        console.log("âœ… å£çº¸å·²æ›´æ¢");

                        // å¯é€‰ï¼šå°†å£çº¸ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Œåˆ·æ–°é¡µé¢ä¹Ÿä¸ä¸¢å¤±
                        localStorage.setItem('user_wallpaper', event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„å£çº¸
            const savedBg = localStorage.getItem('user_wallpaper');
            if (savedBg) {
                document.getElementById('bgLayer').style.backgroundImage = `url('${savedBg}')`;
            }
                    });
    </script>
</body>
</html>
